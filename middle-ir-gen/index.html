
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://accsys.pages.zjusct.io/accipit/middle-ir-gen/">
      
      
        <link rel="prev" href="../semantics/">
      
      
        <link rel="next" href="../backend/">
      
      
      <link rel="icon" href="../images/accsys.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.26">
    
    
      
        <title>Lab 3 中间代码生成 - 浙江大学编译原理课程实验</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="https://cdn.tonycrane.cc/utils/katex.min.css">
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:500,500i,600,600i&display=fallback">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-3" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href=".." title="浙江大学编译原理课程实验" class="md-header__button md-logo" aria-label="浙江大学编译原理课程实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            浙江大学编译原理课程实验
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 3 中间代码生成
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://git.zju.edu.cn/accsys/accipit" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    accsys/accipit
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="浙江大学编译原理课程实验" class="md-nav__button md-logo" aria-label="浙江大学编译原理课程实验" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    浙江大学编译原理课程实验
  </label>
  
    <div class="md-nav__source">
      <a href="https://git.zju.edu.cn/accsys/accipit" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    accsys/accipit
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    主页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    更新日志
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../environment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 0 环境配置
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../syntax/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 1 词法与语法分析
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../semantics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 2 语义分析
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Lab 3 中间代码生成
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Lab 3 中间代码生成
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      背景知识
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      中间代码的定义
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中间代码的定义">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      基本块的处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      局部变量的处理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      语法制导代码生成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语法制导代码生成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      表达式生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      语句生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      短路
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      解释器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="解释器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      使用方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      你的任务
    </span>
  </a>
  
    <nav class="md-nav" aria-label="你的任务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    <span class="md-ellipsis">
      C++ 模板代码说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="C++ 模板代码说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    <span class="md-ellipsis">
      Type 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value" class="md-nav__link">
    <span class="md-ellipsis">
      Value 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ir-structures" class="md-nav__link">
    <span class="md-ellipsis">
      IR Structures
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      使用示例和单元测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../backend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Lab 4 后端代码生成（草稿）
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../appendix/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    附录
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            附录
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/sysy-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SysY 语言规范
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/sysy-runtime/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SysY 运行时库
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/accipit-spec/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accipit IR 规范
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/quads2ssa/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    从四元组到静态单赋值形式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/sysy-accipit-mapping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SysY 结构与 Accipit IR 的对应
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../appendix/faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      背景知识
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      中间代码的定义
    </span>
  </a>
  
    <nav class="md-nav" aria-label="中间代码的定义">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      基本块的处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      局部变量的处理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      语法制导代码生成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="语法制导代码生成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      表达式生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      语句生成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      短路
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      解释器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="解释器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      使用方法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      你的任务
    </span>
  </a>
  
    <nav class="md-nav" aria-label="你的任务">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#c" class="md-nav__link">
    <span class="md-ellipsis">
      C++ 模板代码说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="C++ 模板代码说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#utils" class="md-nav__link">
    <span class="md-ellipsis">
      Utils
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type" class="md-nav__link">
    <span class="md-ellipsis">
      Type 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#value" class="md-nav__link">
    <span class="md-ellipsis">
      Value 类
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ir-structures" class="md-nav__link">
    <span class="md-ellipsis">
      IR Structures
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      使用示例和单元测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="lab-3">Lab 3：中间代码生成<a class="headerlink" href="#lab-3" title="Permanent link">&para;</a></h1>
<h2 id="_1">背景知识<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>正如课上可能提到过的，如果没有中间表示 (Intermediate Representation，简称 IR)，n 门语言 m 种硬件平台各自写编译器，就可能需要 n * m 种编译器，但是 n 门语言的前端编译到一个统一的 IR 然后再由 IR 编译到不同的后端，这样只需要 n + m 个“编译器”.</p>
<p>但是，IR 的作用并不仅限于减少编译器开发的工作量，在现代编译器架构下，具体体现在 IR 所指代的对象宽泛化了，现在 IR 通常可以用于泛指“源代码”与“目标平台汇编”之间的各种表示形式，例如抽象语法树、目标无关的中间代码、三地址码风格的类机器代码层等，从中间代码所在的抽象层次来看：</p>
<ul>
<li><strong>抽象语法树 AST（高层 IR）</strong>：树形结构，贴近源代码层，适合做语法糖的展开、构建符号表、类型检查等靠近编程语言的高层级抽象的任务.
它们和程序语言的设计风格息息相关，因此能够做一些更抽象、更高级的优化.
例如，AST 层级仍然保留结构化控制流（例如 while loop, for loop, if, switch，函数式风格的可能有 parallel, reduce, yield 等）信息，模式匹配 (pattern match) 就可以被展开为一棵高效的决策树 (decison tree)，减少多余的比较和跳转.</li>
<li><strong>目标无关的中间代码（中层 IR）</strong>：本实验讨论的部分. 常见的设计是线性指令.
由于是平台无关的，设计上通常会考虑屏蔽底层细节；由于考虑适配多语言前端的需要，抛弃了多数高层级信息，更为贴合底层汇编.
例如 LLVM IR 在形式上就非常类似 RISC 汇编，但是仍然有 GEP 这样的高级指令.
在这一层级，通常只剩下了非结构化控制流（例如无条件跳转 jump，分支跳转 branch 等），进行例如常量传播、公共子表达式折叠、不变式归纳等与硬件细节无关的优化，以及控制流分析、数据流分析、别名分析等普适的分析.</li>
<li><strong>三地址码或四元组风格的类机器代码层（低层 IR）</strong>，形式上非常接近汇编，甚至可以直接按照汇编指令的格式设计.
这一层非常靠近硬件，优化需要考虑不同指令的延迟、吞吐量、流水线、ABI 等，许多问题是 NP-Hard 的.</li>
</ul>
<p>我们可以看到，实际上每一层“中间表示”都有各自的特点，依次从高抽象走向低级，适合做的任务也不同，每一层都是一个小型的“编译系统”，因此现代编译器通常会采用多层 IR.
此外，由于涉及的任务不同，IR 也有不同的结构结构特征：</p>
<ul>
<li><strong>树或者图结构</strong>：使用图（graph）来表示程序的信息，用节点表示程序里的对象，用边表示关系，此类结构一般能详尽准确地描述程序内的各类信息. 抽象语法树（AST）是一种典型的树形 IR.</li>
<li><strong>线型结构</strong>：例如汇编语言中指令之间就是线型关系。你可以将这种中间代码看成是某种抽象计算机的一个简单的指令集。</li>
<li><strong>混合型</strong>：混合了图和线性两种中间代码风格，例如本实验所使用的 Accipit IR. Accipit IR 将代码组织成许多基本块，块内部采用线型表示，块与块之间采用图表示.</li>
</ul>
<p>Rust 就曾经在前端增加了一层图结构 <a href="https://blog.rust-lang.org/2016/04/19/MIR.html">MIR</a>，borrow checker 就在 MIR 层上进行分析：</p>
<p><img alt="Introducing MIR" src="../images/flow.svg" /></p>
<p>当然，并不是说抽象层级越高，相应地结构特征就会越复杂.
例如，C 语言的源码是线型的字符串，语句与语句之间也线型的；WASM 汇编可以使用类似树形的 SExpr 格式嵌套表示.</p>
<div class="highlight"><span class="filename">add.wast</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>(func (export &quot;add&quot;) (param $x i32) (param $y i32)
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>    (result i32) 
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>    (i32.add 
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>        (local.get $x)
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>        (local.get $y)
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>    )
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>)
</code></pre></div>
<h2 id="_2">中间代码的定义<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>本实验的 IR 是类似 LLVM IR 的 partial SSA 形式，即利用 <code>alloca</code> <code>load</code> <code>store</code> 三条指令在 SSA 形式上“开洞”，具体的规范请参阅 <a href="../appendix/accipit-spec/">Accipit IR 规范</a>.
我们在附录还提供了一些样例：<a href="../appendix/sysy-accipit-mapping/">SysY 结构与 Accipit IR 的对应</a>，为你演示如何从 SysY 前端的高层级结构翻译到 Accipit IR。</p>
<p>下面这段阶乘的样例代码能帮助你实现一个功能正确（虽然显然欠优化的）的中端代码.</p>
<p>源码：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">factorial</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">ans</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ans</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="p">}</span>
</code></pre></div>
<p>参考中间代码：
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">fn</span><span class="w"> </span><span class="o">@</span><span class="n">factorial</span><span class="p">(#</span><span class="n">n</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="o">%</span><span class="n">Lentry</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="c1">// create a stack slot of i32 type as the space of the return value.</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="c1">// if n equals 1, store `1` to this address, i.e. `return 1`,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="c1">// otherwise, do recursive call, i.e. return n * factorial(n - 1).</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="c1">// store function parameter on the stack.</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="p">#</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">    </span><span class="c1">// create a slot for local variable ans, uninitialized.</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">ans</span><span class="p">.</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloca</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">    </span><span class="c1">// when we need #n, you just read it from %n.addr.</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">    </span><span class="c1">// comparison produce an `i8` value.</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">cmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eq</span><span class="w"> </span><span class="o">%</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="n">br</span><span class="w"> </span><span class="o">%</span><span class="n">cmp</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">Ltrue</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">Lfalse</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="o">%</span><span class="n">Ltrue</span><span class="p">:</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="c1">// retuen value = 1.</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">Lret</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="o">%</span><span class="n">Lfalse</span><span class="p">:</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="c1">// n - 1</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">%</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="c1">// factorial(n - 1)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="o">@</span><span class="n">factorial</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">14</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">    </span><span class="c1">// n</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">n</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">    </span><span class="c1">// n * factorial(n - 1)</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mul</span><span class="w"> </span><span class="o">%</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">res</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">    </span><span class="c1">// write local variable `ans`</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">%</span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ans</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">    </span><span class="c1">// now we meets `return ans`, which means we</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">    </span><span class="c1">// should first read value from `%ans.addr` and then</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a><span class="w">    </span><span class="c1">// write it to `%ret.addr`.</span>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">ans</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">%</span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">Lret</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a><span class="o">%</span><span class="n">Lret</span><span class="p">:</span>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">    </span><span class="c1">// load return value from %ret.addr</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">addr</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">%</span><span class="n">ret</span><span class="p">.</span><span class="n">val</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="p">}</span>
</code></pre></div></p>
<h3 id="_3">基本块的处理<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>基本块是划分控制流的边界，基本块内指令有序地线性执行，控制流跳转只存在于基本块之间，这种关系使得基本块之间连成一个有向图，一般称这个有向图为控制流图 (Contorl Flow Graph，简称 CFG).
例如：<code>if</code> 的两个分支分别翻译到两个基本块 <code>Ltrue</code> 与 <code>Lfalse</code>.</p>
<p><img alt="CFG" src="../images/factorial.svg" /></p>
<p>上图是使用 llvm 组件生成的可视化控制流图，你可以使用以下命令获得：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1"># clang emit llvm bytecode</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>$<span class="w"> </span>clang<span class="w"> </span>-S<span class="w"> </span>-emit-llvm<span class="w"> </span>file.c<span class="w"> </span>-o<span class="w"> </span>file.bc
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="c1"># convert to dot file</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>$<span class="w"> </span>opt<span class="w"> </span>-dot-cfg<span class="w"> </span>-disable-output<span class="w"> </span>-enable-new-pm<span class="o">=</span><span class="m">0</span><span class="w"> </span>file.bc
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="c1"># if you are using a newer version of LLVM toolchain with new PassManager, try</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="c1"># $ opt -passes=dot-cfg -disable-output test.bc</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>Writing<span class="w"> </span><span class="s1">&#39;.file.dot&#39;</span>...
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="c1"># dot render png file</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>$<span class="w"> </span>dot<span class="w"> </span>-Tpng<span class="w"> </span>-o<span class="w"> </span>file.png<span class="w"> </span>.file.dot
</code></pre></div>
<p>在 <code>if</code> 分支入口前，有一个基本块作为入口，计算 <code>if</code> 条件的真假，即 <code>%cmp</code>； 
在 <code>if</code> 的两个分支结束后，控制流进行了“合并”，处理下一个语句块，进行一个无条件跳转 <code>br label %ret</code>，来到了出口基本块 <code>%ret</code>.
这是结构化控制流通常的处理思路，你可以将其类推到 <code>while</code> 循环，下面是一个示意图：</p>
<p><img alt="while" src="../images/while.svg" /></p>
<h3 id="_4">局部变量的处理<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>最简单的实现方式是为所有局部作用域的变量都开辟一块栈上的空间，读局部变量就是 load 对应的地址（IR 中即为 alloca 获取的指针类型的值），写局部变量就是把结果 store 入对应的地址.</p>
<p>如果你还不明白，请看下面的示意图并佐以<a href="../appendix/sysy-accipit-mapping/">SysY 结构与 Accipit IR 的对应</a>：</p>
<p><img alt="frame" src="../images/frame.svg" /></p>
<h2 id="_5">语法制导代码生成<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>下一步我们就要把经过语义检查语法树转换成 Accipit 中间代码.
首先，简要回顾 Accipit IR 的结构，详细请看 <a href="../appendix/accipit-spec/">Accipit IR 规范</a>：</p>
<ul>
<li><strong>Type（类型）</strong>：包括基本类型 <code>i32</code> <code>()</code> 以及指针类型、函数类型.</li>
<li><strong>Instruction（指令）</strong>：指令分为 value binding 和 terminator 两类. 前者主要进行数据操作，有 <code>let</code> 开头，定义一个新变量；后者主要进行控制流操作，如无条件跳转和条件跳转等.</li>
<li><strong>Value（值）</strong>：值包含指令所定义的符号 <code>symbol</code> 和常量 <code>const</code> 两类.</li>
<li><strong>BasicBlock（基本块）</strong>：基本块包含若干线性排列的指令序列，其中最后一条指令必须是 terminator. 基本块内部的指令序列线性排列，线性执行（线性结构）；基本块之间的跳转构成图结构，表示控制流的跳转（图结构）.</li>
<li><strong>Function（函数）</strong>：函数的名称，类型等.</li>
<li><strong>Module（模块）</strong>：表示整个编译单元，包含函数和全局变量等.</li>
</ul>
<p>以及再次重申这条重要原则：</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>出于某种神秘的原因，我们规定每个变量只能在定义的时候被赋值一次. 也就是说，每条 value binding 类型的指令的定义的变量，在对应的作用域内要求是<strong>唯一</strong>的，至于为什么，你可以参考<a href="quads2ssa.md">附录：从四元组到静态单赋值形式</a>.
所以，我们在语法上用 <code>let</code> 来暗示这一点.
有一些相应的翻译技巧处理源代码出现多次赋值的情况，详细请看<a href="sysy-accipit-mapping.md">附录：SysY 结构与 Accipit IR 的对应</a></p>
</div>
<p>翻译的基本思路是遍历语法树的节点，然后根据节点的类型生成对应的中间代码.
整个翻译的最大矛盾在于前端树结构的语法树和后端线性的汇编之间的差异，本实验的核心哲学便在于中间代码如何连接这两种迥异的代码表示形式：</p>
<ul>
<li><strong>数据依赖（Data Dependency）</strong>：语法树只记录了变量的名字而且可能有重名变量，而汇编的只能操作有限的物理寄存器. 中间代码需要理清表达式所使用的变量的数据来源，从而能够最终映射到寄存器操作上. Accipit IR 规范中的 value 一定程度上表征了“数据”，即符号或常量.</li>
<li><strong>控制流（Control Flow）</strong>：语法树语句块是结构化的、嵌套的树形结构，并没有显式的控制流跳转；汇编是线型的，需要给不同的子语句块标记 label，并加上合适的跳转指令. 中间代码需要理清不同语句块之间的控制流跳转关系.</li>
</ul>
<p>我们实现一个 translate_X 函数，X 对应表达式，语句等等.</p>
<ul>
<li><code>translate_expr</code> 将表达式翻译到中端 IR 的 value. 起到跟踪数据依赖关系，完成表达式翻译到线性的指令的任务.</li>
<li><code>translate_stmt</code> 将语句块翻译到中端 IR 的 basicblock.
你需要跟踪控制流，将语句块之间的关系翻译到控制流跳转任务，插入合适的 terminator 指令.</li>
</ul>
<h3 id="_6">表达式生成<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>在 Accipit IR 中，值 (value) 包括变量和常数.</p>
<p>我们先定义 <code>Value</code> 类型，并给出一些可供参考的实现方式：</p>
<div class="admonition tip">
<p class="admonition-title">实现建议</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">C</label><label for="__tabbed_1_2">C++</label><label for="__tabbed_1_3">OCaml</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>C 通常使用 enum + union：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="k">enum</span><span class="w"> </span><span class="n">value_kind</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">kind_constant_int32</span><span class="p">,</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">    </span><span class="n">Kind_constant_unit</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="n">kind_binary_expression</span><span class="p">,</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w">    </span><span class="n">kind_function_call</span><span class="p">,</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w">    </span><span class="n">kind_load</span><span class="p">,</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span><span class="n">kind_store</span><span class="p">,</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="p">};</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="n">value_kind</span><span class="w"> </span><span class="n">kind</span><span class="p">,</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">type</span><span class="w"> </span><span class="o">*</span><span class="n">ty</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">constant_int32</span><span class="p">;</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">binary_op</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="o">*</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">rhs</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">binary_expr</span><span class="p">;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">*</span><span class="n">callee</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vector</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">function_call</span><span class="p">;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="o">*</span><span class="w"> </span><span class="n">src_addr</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">load</span><span class="p">;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="o">*</span><span class="w"> </span><span class="n">dest_addr</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="o">*</span><span class="n">value_to_be_stored</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">store</span><span class="p">;</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="p">};</span>
</code></pre></div>
<p>使用一个枚举类型 enum 来标记 Value 的类型，union 来存储不同 Value 的 field，这种方式我们一般称为 "tagged union".
因此，在遍历 Value 时，需要根据 Value 的类型来做不同的操作：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">handle_value</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">value</span><span class="w"> </span><span class="o">*</span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="o">-&gt;</span><span class="n">kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kind_constant_int32</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">            </span><span class="n">handle_constant_int32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kind_constant_unit</span><span class="p">:</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w">            </span><span class="n">handle_constant_unit</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kind_binary_expression</span><span class="p">:</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w">            </span><span class="n">handle_binary_expression</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">kind_store</span><span class="p">:</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w">            </span><span class="n">handle_store_expression</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w">        </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w">            </span><span class="n">raise_error_and_dump</span><span class="p">();</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="p">}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>C++ 可以使用 <code>std::variant</code> 来代替 C 的 enum + union 来实现 “类型安全” 的 tagged union，具体可以看 <a href="https://en.cppreference.com/w/cpp/utility/variant">cpp reference</a>。
简单来说，当一个 Value 实际上是 <code>kind_constant_int32</code> 类型，但是你错误地使用了处理 <code>kind_binary_expression</code> 类型的函数处理它，就会错误地把这个 Value 当作二元表达式来处理，因此得出错误的结果，然而不论是编译时还是运行时都不会对这样的误用产生任何的报错。
而 <code>std::variant</code> 会在上述情况发生时扔出异常，方便你 debug。</p>
<p>除了 C 风格，C++ 可以使用面对对象实现：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">ty</span><span class="p">;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w">    </span><span class="cm">/*...*/</span><span class="w"> </span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="p">};</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConstantInt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">;</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">    </span><span class="cm">/*...*/</span><span class="w"> </span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="p">};</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">BinaryExpr</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">rhs</span><span class="p">;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="cm">/*...*/</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="p">};</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">FnCall</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">    </span><span class="n">Function</span><span class="w"> </span><span class="o">*</span><span class="n">callee</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">args</span><span class="p">;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="p">};</span>
</code></pre></div>
<p>在这种实现模式下，在遍历 Value 时如何判断当前 Value 是哪种类型，以便我们用正确的函数处理不同类型的 Value 呢？
有三大类方法：</p>
<ul>
<li>
<p>使用虚函数（不推荐）</p>
<p>例如，我一个打印 IR 的函数叫做 <code>print_value</code>，给 Value 声明一个虚成员函数 <code>virtual void print_value()</code>，然后每个 Value 的子类继承时重载这个函数，这样我们就可以对所有 Value 类型的变量直接调用 <code>value-&gt;print_value()</code> 即可.
但是缺点是，你永远不可能知道你到底需要多少这样的处理 Value 的函数，新增一个 <code>Value::foo()</code>，你就要回过头去修改所有 Value 以及子类的声明；再新增一个 <code>Value::bar()</code>，你还要重复上面的事情.
这样很麻烦，而且也不优雅.
因此虚函数只适合类似 print 必要的和功能固定的操作.</p>
</li>
<li>
<p>使用 RTTI（可行，<del>自己看着用.jpg</del>）</p>
<p>C++ 标准有一个特性 “运行时类型识别” (Runtime Type Identification, RTTI).
使用运算符 <code>typeid</code> 会返回一个运行时的、对用户不透明的 <code>std::type_info</code> 类型，具体可参考 <a href="https://en.cppreference.com/w/cpp/types/type_info">cpp reference</a>.
你可以获取 <code>type_info</code> 的内部名字以及通过 <code>==</code> 比较两个 <code>type_info</code> 是否相等，这里我们为大家编写了一个 <a href="https://godbolt.org/z/o4W7To3Ya">godbolt 在线样例</a>.</p>
</li>
<li>
<p>使用模板黑魔法（推荐，写起来优雅，<del>不得不品尝的环节出现了，大雾</del>）</p>
<p>这个方法不需要 C++ 的 RTTI，本质上仍然是 C 风格的 “enum + union”，但是更安全，只需要用到用到 C++ 11 的 <code>type_traits</code> 标准库和一点点模板魔法.</p>
<p>首先，常见的做法是新建一个 <code>Common.def</code>，然后定义宏：</p>
<div class="highlight"><span class="filename">Common.def</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#ifndef ValueKindDefine</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="cp">#define ValuKindDefine(x)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cp">#endif</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_ConstantInt</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_ConstantUnit</span><span class="p">)</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_BinaryExpr</span><span class="p">)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_Alloca</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="c1">// ....</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_Store</span><span class="p">)</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="n">ValueKindDefine</span><span class="p">(</span><span class="n">SV_Load</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="c1">// Gaurd</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="cp">#undef ValueKindDefine</span>
</code></pre></div>
<p>这个宏的作用是利用 include 的原理是直接文本插入来让编译器帮你完成 enum 的填写：</p>
<div class="highlight"><span class="filename">Value.h</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="cp">#define ValueTypeDefine(x) x,</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="k">enum</span><span class="w"> </span><span class="nc">ValueKind</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Common/Common.def&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">};</span>
</code></pre></div>
<p>这样我们就完成了类似 C 中 value_kind 的 enum 定义，然后在基类 Value 中添加 <code>value_kind</code> 字段，这个字段标识了这个 Value 具体是哪个类型，你还可以利用 C++ 11 的初始化静态成员语法来给所有 Value 的子类初始化 <code>value_kind</code> 字段：</p>
<div class="highlight"><span class="filename">Value.h</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">protected</span><span class="o">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="cm">/*...*/</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="n">ValueKind</span><span class="w"> </span><span class="n">value_kind</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="n">Value</span><span class="p">(</span><span class="n">ValueKind</span><span class="w"> </span><span class="n">kind</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="n">value_kind</span><span class="p">(</span><span class="n">kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="p">};</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a><span class="k">class</span><span class="w"> </span><span class="nc">ConstantInt</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ValueKind</span><span class="w"> </span><span class="n">this_kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SV_ConstantInt</span><span class="p">;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">    </span><span class="n">ConstantInt</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="n">Value</span><span class="p">(</span><span class="n">value_kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number</span><span class="p">;</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">    </span><span class="cm">/*...*/</span><span class="w"> </span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="p">};</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">BinaryExpr</span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">    </span><span class="k">constexpr</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">ValueKind</span><span class="w"> </span><span class="n">this_kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SV_BinaryExpr</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a><span class="w">    </span><span class="n">BinaryExpr</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="n">Value</span><span class="p">(</span><span class="n">this_kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">lhs</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">rhs</span><span class="p">;</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">    </span><span class="cm">/*...*/</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="p">};</span>
</code></pre></div>
<p><del>到这一步你回头还来得及</del>，其实以上这些代码已经足够让你像 C 一样通过 <code>value_kind</code> 这个标记来区分不同的 Value 了：每个 Value 的子类的构造函数都会将自己这个类的标记 <code>this_kind</code> 赋给基类的 <code>value_kind</code>.
但是，模板魔法能让他们更进一步，接下来是两个最最重要的模板：</p>
<div class="highlight"><span class="filename">Value.h</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Value</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="c1">// ...</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="k">public</span><span class="o">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">is</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">value_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">remove_pointer_t</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">this_kind</span><span class="p">;</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">    </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="n">as</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">is</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="p">};</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">constant_int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConstantInt</span><span class="p">;</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="c1">// variable `constant_int` is NOT `BinaryExpr` type</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">is</span><span class="o">&lt;</span><span class="n">BinaryExpr</span><span class="o">&gt;</span><span class="p">())</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="c1">// variable `constant_int` is `ConstantInt` type</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="n">assert</span><span class="p">(</span><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">is</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="o">&gt;</span><span class="p">())</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*</span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Yes, `constant_int` is ConstantInt, \</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="s">                so the branch is reachable&quot;</span><span class="p">);</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="p">}</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BinaryExpr</span><span class="w"> </span><span class="o">*</span><span class="n">inner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="n">BinaryExpr</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;No, `constant_int` is NOT BinaryExpr, \</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="s">                so this branch is unreachable&quot;</span><span class="p">);</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="p">}</span>
</code></pre></div>
<p>首先，对于 <code>is</code> 模板，<code>constant_int-&gt;is&lt;BinaryExpr&gt;()</code> 实际上在做：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">value_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">BinaryExpr</span><span class="o">::</span><span class="n">this_kind</span><span class="p">;</span>
</code></pre></div>
<p>由于 <code>constant_int</code> 的 value_kind 是 <code>SV_ConstantInt</code> 因此返回 false.</p>
<p>同理，对于 <code>as</code> 模板，<code>if (ConstantInt *inner = constant_int-&gt;as&lt;ConstantInt *&gt;()) { ... }</code> 实际上做的是：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="c1">// `std::remove_pointer_t&lt;ConstantInt *&gt;` gets `ConstantInt`</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">constant_int</span><span class="o">-&gt;</span><span class="n">value_kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">this_kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="c1">// safe cast, or ...</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*</span><span class="p">)(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">    </span><span class="c1">// return nullptr as failure</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="p">}</span>
</code></pre></div>
<p>也就是说，如果 <code>is</code> 检查通过了，就能安全地 cast 到对应的子类型，否则返回 nullptr.
返回 nullptr 很大程度上方便了上面这种在 if 的条件里面定义变量的语法，如果是正确的类型，就会进入 if 的真分支；否则返回 nullptr 就不会进入 if 真分支.</p>
<p><strong>注意</strong>: <code>std::remove_pointer_t</code> 是必须的，因为我们通常会和 <code>Value *</code> 类型打交道，而不是 <code>Value</code> 本身.
你会发现 <code>is</code> 使用的模板参数是 Value 的子类型本身，而 <code>as</code> 通常用的是 Value 子类型的指针.</p>
<p>完成了上述基础设施之后，下面我们来看怎么处理不同的 Value 类型，考虑 print 操作：</p>
<ul>
<li>
<p>一是 C 风格的 switch 分发：</p>
<div class="highlight"><span class="filename">IRPrinter.cpp</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printValue</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="o">-&gt;</span><span class="n">value_kind</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="cp">#define ValueTypeDefine(type) \</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="cp">    case x: print##type(V);   \</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="cp">            break;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Common.def&quot;</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">        </span><span class="cm">/* ... */</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="p">}</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="c1">// Individual function for each value kind.</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printSV_ConstantInt</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printSV_BinaryExpr</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
</li>
<li>
<p>一是用上面的 "if + as" 结构：</p>
<div class="highlight"><span class="filename">IRPrinter.cpp</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">printValue</span><span class="p">(</span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">C</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="n">ConstantInt</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">        </span><span class="n">C</span><span class="o">-&gt;</span><span class="n">foo</span><span class="p">();</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="o">-&gt;</span><span class="n">as</span><span class="o">&lt;</span><span class="n">BinaryExpr</span><span class="w"> </span><span class="o">*&gt;</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="n">B</span><span class="o">-&gt;</span><span class="n">bar</span><span class="p">();</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="cm">/* ... */</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="p">}</span>
</code></pre></div>
</li>
</ul>
</li>
</ul>
</div>
<div class="tabbed-block">
<p>ML 系语言以及 Rust 都支持代数数据类型 (Algebraic Data Type)，可以很方便地定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">type</span> <span class="nc">ValueKinds</span> <span class="o">=</span> <span class="nc">ConstantInt</span> <span class="k">of</span> <span class="kt">int</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>    <span class="o">|</span> <span class="nc">ConstantUnit</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>    <span class="o">|</span> <span class="nc">BinaryExpr</span> <span class="k">of</span> <span class="nc">BinOp</span> <span class="o">*</span> <span class="nc">Value</span> <span class="o">*</span> <span class="nc">Value</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>    <span class="o">|</span> <span class="nc">FunctionCall</span> <span class="k">of</span> <span class="nc">Function</span> <span class="o">*</span> <span class="nc">Value</span> <span class="kt">list</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>    <span class="o">|</span> <span class="nc">Load</span> <span class="k">of</span> <span class="nc">Value</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>    <span class="o">|</span> <span class="nc">Store</span> <span class="k">of</span> <span class="nc">Value</span> <span class="o">*</span> <span class="nc">Value</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="k">and</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="k">type</span> <span class="nc">Value</span> <span class="o">=</span> <span class="nc">Type</span> <span class="o">*</span> <span class="nc">ValueKinds</span>
</code></pre></div>
<p>都直接 ADT 了，pattern match 吧...</p>
</div>
</div>
</div>
</div>
<p>然后我们定义 <code>translate_expr</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>translate_expr(expr, symbol_table, current_bb) -&gt; value
</code></pre></div>
<p>其中 <code>symbol_table</code> 是符号表，维护一个 <code>string -&gt; value</code> 的映射，虽然在类似 SSA 的形式下，变量的名字并不重要，但是在处理局部变量时，我们要每个局部变量分配一个栈上的地址，为此我们需要记录变量名字到对应 alloca 指令的映射.
对于重复命名的变量，如在一个语句块里定义的变量和外层的变量重名时，请你自行处理.</p>
<p>由于 <code>translate_expr</code> 只是翻译表达式，没有任何控制流转移，因此只会生成线性的指令流，因此考虑传入基本块信息 <code>current_bb</code>，表示当前控制流在 <code>current_bb</code> 这个基本块，翻译得到的指令序列应当插入此处.</p>
<p>面对形如 <code>expr1 + expr2</code> 这样的二元表达式（下文记作 <code>expr0</code>），调用 <code>translate_expr(expr0, sym_table, current_bb)</code> 进行翻译.
我们递归调用两个子节点的 <code>translate_expr</code>，然后生成一条加法指令将他们加起来，最后 <code>result_value</code> 将作为最后的返回值：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>lhs_value = translate_expr(expr1, sym_table, current_bb)
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>rhs_value = translate_expr(expr2, sym_table, current_bb)
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>result_value = create_binary(addop, lhs_value, rhs_value, current_bb)
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>return result_value
</code></pre></div>
<p>上面生成的指令在 IR 中看起来可能像这样，其中 <code>%2</code> 是 <code>translate_expr(expr0, sym_table, current_bb)</code> 最后的返回值：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="c1">// lhs value, anonymous</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">....</span><span class="p">.</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="c1">// rhs value, anonymous</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">....</span><span class="p">.</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="sd">/// result value, anonymous</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="kd">let</span><span class="w"> </span><span class="o">%</span><span class="mi">2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">%</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="mi">1</span>
</code></pre></div>
<p>我们可以将表达式的翻译规则总结如下：</p>
<style>
code {
    font-family: 'Jetbrains Mono', Menlo, Monaco, Consolas, 'Lucida Console', monospace;
    font-size: 85%;
    margin: 0;
    hyphens: manual;
}
pre {
    margin: 1em 0;
    overflow: auto;
}
pre code {
    padding: 0;
    overflow: visible;
    overflow-wrap: normal;
}
.sourceCode {
    background-color: transparent;
    overflow: visible;
}
table {
    margin: 1em 0;
    border-collapse: collapse;
    width: 100%;
    overflow-x: auto;
    display: block;
    font-variant-numeric: lining-nums tabular-nums;
}
table caption {
    margin-bottom: 0.75em;
}
tbody {
    margin-top: 0.5em;
    border-top: 1px solid #1a1a1a;
    border-bottom: 1px solid #1a1a1a;
}
th {
    border-top: 1px solid #1a1a1a;
    padding: 0.25em 0.5em 0.25em 0.5em;
}
td {
    padding: 0.125em 0.5em 0.25em 0.5em;
}
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
/* The extra [class] is a hack that increases specificity enough to
    override a similar rule in reveal.js */
ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
    font-size: inherit;
    width: 0.8em;
    margin: 0 0.8em 0.2em -1.6em;
    vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
    { counter-reset: source-line 0; }
pre.numberSource code > span
    { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
    { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
    }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
    {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<table>
<colgroup>
<col style="width: 24%" />
<col style="width: 75%" />
</colgroup>
<thead>
<tr class="header">
<th>Expr</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>INT</code></td>
<td><div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>number <span class="op">=</span> get_number<span class="op">(</span>INT<span class="op">);</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> create_constant_int32<span class="op">(</span>number<span class="op">);</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>ID</code></td>
<td><div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>addr_of_value <span class="op">=</span> lookup<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span>`</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> create_load<span class="op">(</span>addr_of_value<span class="op">,</span> current_bb<span class="op">);</span></span></code></pre></div></td>
</tr>
<tr class="odd">
<td><code>Expr1 BinOp Expr2</code></td>
<td><div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>binop <span class="op">=</span> get_binop<span class="op">(</span>BinOp<span class="op">);</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>expr1_value <span class="op">=</span> translate_expr<span class="op">(</span>expr1<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>expr2_value <span class="op">=</span> translate_expr<span class="op">(</span>expr2<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> create_binary<span class="op">(</span>binop<span class="op">,</span> expr1_value<span class="op">,</span> expr2_value<span class="op">,</span> current_bb<span class="op">);</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>MINUS Expr1</code></td>
<td><div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>zero_value <span class="op">=</span> create_constant_int32<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>expr1_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr1<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> create_binary<span class="op">(</span>subop<span class="op">,</span> zero_value<span class="op">,</span> expr1_value<span class="op">,</span> current_bb<span class="op">);</span></span></code></pre></div></td>
</tr>
<tr class="odd">
<td><code>Call ID, Args</code></td>
<td><pre><code>function = lookup(sym_table, ID);
args_list = [];
for arg in Args:
  args_list += translate_expr(arg, sym_table, current_bb);
return create_function_call(function, args_list, current_bb);</code></pre></td>
</tr>
<tr class="even">
<td><code>ID[Idx1]...[IdxN]</code></td>
<td><div class="sourceCode" id="cb5"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// element type</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>array_type <span class="op">=</span> lookup_var_type<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>elem_type <span class="op">=</span> get_elem_type<span class="op">(</span>array_type<span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// address of the first element in the array,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">// which is actually the stack address represented</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">// by a &#39;alloca&#39; instruction or a global variable.</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>addr_value <span class="op">=</span> lookup<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">// indices</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> <span class="op">[];</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx in Idx1<span class="op">..</span>IdxN<span class="op">:</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  indices <span class="op">+=</span> translate_expr<span class="op">(</span>idx<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">// bounds</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>bounds <span class="op">=</span> get_bounds<span class="op">(</span>array_type<span class="op">);</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> create_load<span class="op">(<span class="op">create_offset<span class="op">(</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  elem_type<span class="op">,</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  addr_value<span class="op">,</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  indices<span class="op">,</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  bounds</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">)<span class="op">);</span></span></code></pre></div></td>
</tr>
</tbody>
</table>

<p>其中 <code>create_load</code> <code>create_binary</code> <code>create_function_call</code> 等是生成指令的接口，它们的最后一个参数是基本块 <code>current_block</code>，表示指令在基本块 <code>current_block</code> 中插入，由于基本块中指令是线性的，你可以在基本块中维护一个 <code>vector</code>，在末端不断加入指令即可，类似于：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">insert_instruction</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">inst</span><span class="p">,</span><span class="w"> </span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">block</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">instrs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">getInstrs</span><span class="p">();</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="n">instrs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">}</span>
</code></pre></div>
<details class="tip">
<summary>数据结构对 IR 的影响</summary>
<p>使用类似数组的数据结构存放指令序列，能够提高 cache 的命中率，这样遍历指令就会很快.
这种实现足够简单，也足够你完成本课程的实验的基础部分了.</p>
<p>但是，如果进行中端的目标无关代码优化，那么需要频繁地删除某些指令，在中间插入某些指令，或者将几条指令替换成更高效的指令，而双端链表相比数组更容易实现上面这些操作. 因此 LLVM 中使用双端链表来存放指令序列——甚至是基本块序列.</p>
<p>即便如此，双端链表的访问效率仍然是个问题，这在 JIT 编译器中是一个减分项. 为此， WebKit B3 JIT compiler 就将后端模块中原来的 LLVM IR 换成了新的 B3 IR，B3 IR 就使用数组存储，为了满足在 B3 IR 层级上进行代码优化的需要，编译器引入了一个 <code>InsertionSet</code> 数据结构.
它记录优化 Pass 中所有的变化，并在最后进行统一插入更新，以提高效率.
如果你对此感兴趣，可以阅读 <a href="https://webkit.org/blog/5852/introducing-the-b3-jit-compiler/">WebKit Blog</a></p>
</details>
<p>需要注意的是，Expr 对应的是右值，也即实际的值，所以需要一条 load 指令；LVal 对应的是左值，以某个地址/指针类型的 Value 表示，不需要一条额外的 load 指令.</p>
<h3 id="_7">语句生成<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>我们定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>translate_stmt(stmt, symbol_table, current_bb) -&gt; exit_bb
</code></pre></div>
<p>由于语句块可能包含控制流的跳转，而且整个语句块整体并没有产生 value，我们考虑 <code>translate_stmt</code> 接受一个基本块参数 <code>current_bb</code>，表示当前控制流在 <code>current_bb</code> 所表示的基本块处；返回一个基本块 <code>exit_bb</code>，表示参数 <code>stmt</code> 翻译结束后，控制流将在 <code>exit_bb</code> 所表示的基本块处基本块继续.
在出现控制流嵌套（例如 If 套 If ）的情况下可能更方便你的处理。</p>
<p>条件语句的生成则要复杂些，我们所定义的基本块结构中间在这里将发挥重要作用.
直觉上来说，If 语句应该生成如下的中间代码：
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="w">    </span><span class="n">stmt1</span><span class="p">;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="n">stmt2</span><span class="p">;</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="p">}</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="w">    </span><span class="n">let</span><span class="w"> </span><span class="o">%</span><span class="n">cond_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">translate_expr</span><span class="p">(</span><span class="n">cond</span><span class="p">)</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="w">    </span><span class="n">br</span><span class="w"> </span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">true_label</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">false_label</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="o">%</span><span class="n">true_label</span><span class="o">:</span>
<a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="w">    </span><span class="n">translate_stmt</span><span class="p">(</span><span class="n">stmt1</span><span class="p">)</span>
<a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">exit_label</span>
<a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="o">%</span><span class="n">false_label</span><span class="o">:</span>
<a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="w">    </span><span class="n">translate_stmt</span><span class="p">(</span><span class="n">stmt2</span><span class="p">)</span>
<a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="w">    </span><span class="n">jmp</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">%</span><span class="n">exit_label</span>
<a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="o">%</span><span class="n">exit_label</span><span class="o">:</span>
<a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="w">    </span><span class="p">...</span>
</code></pre></div></p>
<p><code>cond_value</code> 为真时跳转到 <code>%true_label</code>，为假时跳转到 <code>%false_label</code>，最后两个基本块的控制流在 <code>%exit_label</code> 合并. 
而这也就是 If 语句的<strong>大致</strong>翻译流程：</p>
<ul>
<li>生成新的基本块 <code>true_label</code>，<code>false_label</code> 和 <code>exit_label</code>，分别用于条件为真时的跳转，条件为假时的跳转，控制流的合并.</li>
<li>调用 <code>translate_expr</code> 生成条件表达式的中间代码，传入 <code>true_label</code> 和 <code>false_label</code> 作为条件为真时和条件为假时的跳转位置.</li>
<li>而对于具体的语句，只需要递归调用 <code>translate_stmt</code> 即可.</li>
<li>把 <code>true_label</code> 和 <code>false_label</code> 的终结指令 (Terminator) 设置为 <code>jmp label %exit_label</code> 完成控制流合并.</li>
</ul>
<p><strong>注意</strong>：当你为 If 语句控制流生成 <code>true_label</code> 等新的基本块时，并<strong>不</strong>意味这 If 语句的真分支的语句块语句块 <code>Stmt</code> 结构里的所有子语句 <code>Stmt</code> 结构都会被翻译到 <code>true_label</code> 基本块里.
当出现控制流嵌套时（例如 If 套 While，If 套 If 等），If 语句的真分支就不再是单独一个 <code>true_label</code> 基本块了，而是一个以 <code>true_label</code> 基本块为源点的<strong>控制流子图</strong>，你需要从 If 语句真分支翻译结束后所在的基本块（也就是这个控制流子图的汇点）跳转到 <code>exit_label</code>.
这也是我们为什么在 <code>translate_stmt</code> 中选择返回一个 <code>exit_bb</code>，你可以在下面的伪代码中看到我们是如何利用这一点的.</p>
<p>其余类型的语句和控制流结构本质上是一样的，我们不再一一赘述.
我们总结语句翻译的规则如下：</p>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="header">
<th>Expr</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>VarDecl ID</code></td>
<td><div class="sourceCode" id="cb1"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>entry_bb <span class="op">=</span> get_function_entry_bb<span class="op">();</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>var_type <span class="op">=</span> lookup_var_type<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>alloca_instr <span class="op">=</span> create_alloca<span class="op">(</span>var_type<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> entry_bb<span class="op">);</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>update<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">,</span> alloca_instr<span class="op">);</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> current_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>VarDecl ID[size]</code></td>
<td><div class="sourceCode" id="cb2"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>entry_bb <span class="op">=</span> get_function_entry_bb<span class="op">();</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>var_type <span class="op">=</span> lookup_var_type<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>alloca_instr <span class="op">=</span> create_alloca<span class="op">(</span>var_type<span class="op">,</span> size<span class="op">,</span> entry_bb<span class="op">);</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>update<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">,</span> alloca_instr<span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> current_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="odd">
<td><code>Expr</code></td>
<td><div class="sourceCode" id="cb3"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>translate_expr<span class="op">(</span>expr<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> current_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>ID = Expr</code></td>
<td><div class="sourceCode" id="cb4"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>addr_value <span class="op">=</span> lookup<span class="op">(</span>sym_table<span class="op">,</span> ID<span class="op">);</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>result_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>create_store<span class="op">(</span>result_value<span class="op">,</span> addr_value<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> current_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="odd">
<td><code>If (Expr) Stmt</code></td>
<td><div class="sourceCode" id="cb5"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// new basic block</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>exit_bb <span class="op">=</span> new_label<span class="op">();</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>true_bb <span class="op">=</span> new_label<span class="op">();</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">// calculate condition expr in current basic block.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>cond_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>create_branch<span class="op">(</span>cond_value<span class="op">,</span> true_bb<span class="op">,</span> exit_bb<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">// translate true branch</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>true_exit_bb <span class="op">=</span> translate_stmt<span class="op">(</span>Stmt<span class="op">,</span> sym_table<span class="op">,</span> true_bb<span class="op">);</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>create_jmp<span class="op">(</span>exit_bb<span class="op">,</span> true_exit_bb<span class="op">);</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> exit_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>If (Expr) Stmt1 Else Stmt2</code></td>
<td><div class="sourceCode" id="cb6"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>exit_bb <span class="op">=</span> new_label<span class="op">();</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>true_bb <span class="op">=</span> new_label<span class="op">();</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>false_bb <span class="op">=</span> new_label<span class="op">();</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>cond_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>create_branch<span class="op">(</span>cond<span class="op">,</span> true_bb<span class="op">,</span> false_bb<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>true_exit_bb <span class="op">=</span> translate_stmt<span class="op">(</span>Stmt1<span class="op">,</span> sym_table<span class="op">,</span> true_bb<span class="op">);</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>create_jmp<span class="op">(</span>exit_bb<span class="op">,</span> true_exit_bb<span class="op">);</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>false_exit_bb <span class="op">=</span> translate_stmt<span class="op">(</span>Stmt2<span class="op">,</span> sym_table<span class="op">,</span> false_bb<span class="op">);</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>create_jmp<span class="op">(</span>exit_bb<span class="op">,</span> false_exit_bb<span class="op">);</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> exit_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="odd">
<td><code>While (Expr) Stmt</code></td>
<td><div class="sourceCode" id="cb7"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>entry_bb <span class="op">=</span> new_label<span class="op">()</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>body_bb <span class="op">=</span> new_label<span class="op">()</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>exit_bb <span class="op">=</span> new_label<span class="op">()</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">// entry block of While should be separated.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>create_jump<span class="op">(</span>entry_bb<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>cond_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr<span class="op">,</span> sym_table<span class="op">,</span> entry_bb<span class="op">);</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>create_branch<span class="op">(</span>cond<span class="op">,</span> body_bb<span class="op">,</span> exit_bb<span class="op">,</span> entry_bb<span class="op">);</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>body_exit_bb <span class="op">=</span> translate_stmt<span class="op">(</span>Stmt<span class="op">,</span> sym_table<span class="op">,</span> body_bb<span class="op">);</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>create_jump<span class="op">(</span>entry_bb<span class="op">,</span> body_exit_bb<span class="op">);</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> exit_bb<span class="op">;</span></span></code></pre></div></td>
</tr>
<tr class="even">
<td><code>Return Expr</code></td>
<td><div class="sourceCode" id="cb8"><pre
class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>return_bb <span class="op">=</span> get_function_ret_bb<span class="op">();</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>return_addr <span class="op">=</span> get_function_ret_value_addr<span class="op">();</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>return_value <span class="op">=</span> translate_expr<span class="op">(</span>Expr<span class="op">,</span> sym_table<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">// store the value of Expr to the slot of return value on the stack.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>create_store<span class="op">(</span>return_value<span class="op">,</span> return_addr<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">// jump to the return basic block</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>create_jump<span class="op">(</span>return_bb<span class="op">,</span> current_bb<span class="op">);</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">// the control flow ends with `Return`, so we can return a &#39;empty basic block&#39;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="kw">nullptr</span><span class="op">;</span></span></code></pre></div></td>
</tr>
</tbody>
</table>

<p>你需要特别关注局部变量的声明和返回语句。</p>
<p>局部变量（包括函数参数）声明语句需要翻译成 <code>alloca</code> 指令，用来将它们放在栈空间上.
你需要注意，所有的 <code>alloca</code> 指令都应该放在整个函数开头的入口基本块内，而不是局部变量声明出现的那个语句块对应的基本块.
<code>alloca</code> 指令的作用域是整个函数，如果你“原地翻译”，那么可以想象一下 While 循环内声明一个局部变量——每次循环都分配栈空间，循环次数一多就爆栈了——这个变量被反复分配了新的栈空间.
其次，正如上文 <code>translate_expr</code> 提到的，你需要即时更新符号表 <code>sym_table</code>.</p>
<p>返回语句并不是直接插入 <code>ret</code> 指令那么简单，在底层汇编中，return 通常在函数结尾，除了根据 ABI 将返回值赋给对应的寄存器，你还需要清理栈帧（恢复栈指针，帧指针，恢复 callee saved register 等）.
因此直接原地翻译 return 是不合适的，为了你后端能够舒适一些，你应当在函数入口为返回值安排一块栈空间 <code>%ret.addr</code>，并在函数末尾单独添加一个 <code>%return_bb</code>.
函数体中遇到的 “early return” 应当按如下翻译：</p>
<ul>
<li>将函数的返回值存入 <code>%ret.addr</code></li>
<li>跳转到 <code>%return_bb</code> 处，<strong>同时你不应该再插入别的跳转语句</strong>，特别当 return 位于结构化控制流 If 和 While 内部时</li>
</ul>
<p>对于 <code>%return_bb</code>，你应当：</p>
<ul>
<li>从 <code>%ret.addr</code> 读出函数返回值</li>
<li>插入真正的 <code>ret</code> 指令</li>
</ul>
<h3 id="_8">短路<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>短路（shortcut）是指在逻辑连词中一部分子表示式计算被“跳过”的情况，例如：</p>
<ul>
<li><code>1 &gt; 2 &amp;&amp; call_foo()</code> 由于与运算左侧的 <code>1 &gt; 2</code> 为假（即 0），那么右侧的表达式不会被执行，即 <code>call_foo()</code> 被“跳过”，整个表达式返回 0.</li>
<li><code>1 &lt; 2 || call_bar()</code> 由于或运算左侧的 <code>1 &lt; 2</code>为真（即 1），那么右侧的表达式不会被执行，即 <code>call_bar()</code> 被“跳过”，整个表达式返回 1.</li>
<li>更进一步地，对于类似 <code>1 &gt; 2 &amp;&amp; 3 &gt; 4 &amp;&amp; call_foo()</code> 等连续连词的情况，在 AST 上为 <code>(1 &gt; 2 &amp;&amp; 3 &gt; 4) &amp;&amp; call_foo()</code>，由于 <code>1 &gt; 2</code> 为假，因此 <code>3 &gt; 4</code> 会被“跳过”，因此左侧 <code>(1 &gt; 2 &amp;&amp; 3 &gt; 4)</code> 为 0，进一步右侧 <code>call_foo()</code> 被“跳过”.  </li>
</ul>
<p>纯算术表达式计算被短路对结果并不会有什么影响，但是如果表达式有副作用（例如，考虑上文中的函数调用 <code>call_bar()</code> 会输出一些内容），就会产生语义上的区别。</p>
<p>简言之，短路语义的结果是，在 If 和 While 等语句的条件判断中，并不是先算好整个条件表达式的结果再跳转，而是先算左侧，进行判断：或者短路，直接跳转；或者进行右侧计算，再跳转。
相比上一小节平凡的 If 和 While 语句翻译，你需要展开语句，插入辅助的基本块来翻译控制流信息，例如，下为条件为 <code>&amp;&amp;</code> 表达式的 If 语句控制流图：</p>
<p><img alt="shortcut if and" src="../images/shortcut_if_and.svg" /></p>
<p>其他情况与之类似，我们不再赘述，翻译规则略.</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>C 的赋值语句也有短路语义，例如 <code>int a = 2 &lt; 1 &amp;&amp; 3 &gt; 4</code>.
这引起的结果是 Expr 也可能产生控制流转移，为了方便起见，我们不会测试此类短路情况，但是你有兴趣可以实现.</p>
</div>
<h2 id="_9">解释器<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>为了检测生成的中间代码生成正确性和评测，我们为大家提供了一个该中间表示的解释器。</p>
<blockquote>
<p>尽管我们对于解释器的代码有过一些测试，但面对大家使用的实际情况，很难保证没有新的问题。如果你发现生成的中间代码不能被正确的执行，请及时联系助教</p>
</blockquote>
<h3 id="_10">使用方法<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>Usage: accipit [OPTIONS] &lt;FILE&gt; [ARGS]...
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>Arguments:
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>  &lt;FILE&gt;     Specify the input file
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>  [ARGS]...  Specify the argument passes to the entry function
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>Options:
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>  -o, --output &lt;OUTPUT&gt;  Specify the output file (unused option)
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>      --dump-module      Dump parsed module, producing explicit type annotation and different symbol prefix
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>  -e, --entry &lt;ENTRY&gt;    Specify the certain function as the entry function [default: main]
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>  -h, --help             Print help
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>  -V, --version          Print version
</code></pre></div>
<p>解释器支持直接调用某个函数，并在命令行内传入函数参数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>$<span class="w"> </span>accipit<span class="w"> </span>examples/factorial.acc<span class="w"> </span>--entry<span class="w"> </span>factorial<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>...
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="m">3628800</span>
</code></pre></div>
<p>如果不指定调用某个函数，则默认从 <code>main</code> 开始，从 stdin/stdout 输入输出：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>accipit<span class="w"> </span>examples/factorial.acc
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>...
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="c1"># `getint` waiting for input</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="m">10</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="c1"># `putint` print result</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="m">3628800</span>
</code></pre></div>
<h2 id="_11">你的任务<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>在实现 lexer 和 parser 的基础上，将语法树转换为中间代码，概要地说：</p>
<ul>
<li>从前端 SysY 的类型翻译到 Accipit IR 的类型. Accipit IR 是一个“强类型”的中间表示，且和前端 SysY 的类型有所区别.</li>
<li>实现符号表 <code>sym_table</code> 管理，需要注意此处的符号表和语义分析的任务不同.</li>
<li>实现翻译函数 <code>translate_expr</code> 和 <code>translate_stmt</code> 的功能，即从前端的一棵 <code>Node</code> 类型的语法树，转换到 <code>Module</code>-<code>Function</code>-<code>BasicBlock</code>-<code>Instruction</code> 的 Accipit IR 层级结构.</li>
<li>实现在结构化控制流 If 和 While 中条件表达式短路语义的翻译.</li>
</ul>
<p>你的编译器必须支持两个命令行参数的情形, 即：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>./compiler<span class="w"> </span>&lt;input_file&gt;<span class="w"> </span>&lt;output_file&gt;
</code></pre></div>
<p>该程序必须接受一个输入的源代码文件名、 一个输出的 IR 文本文件名作为参数，我们只会使用这种方式来测试你的编译器. </p>
<h3 id="_12">测试<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<p>运行以下命令来测试你的编译器：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>python3<span class="w"> </span>test.py<span class="w"> </span>./compiler<span class="w"> </span>lab3
</code></pre></div>
<ul>
<li><code>--executor_path=&lt;path&gt;</code> 指定解释器路径，默认为 <code>../target/debug/accipit</code></li>
<li><code>--local</code> 指定将测试样例生成的 IR 文本生成在当前目录的子目录 <code>ir/</code> 下 </li>
</ul>
<h2 id="c">C++ 模板代码说明<a class="headerlink" href="#c" title="Permanent link">&para;</a></h2>
<p>请从 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template">ZJU Git</a> 处获取模板代码，并阅读相关说明.
模板代码已经实现了 IR 的构造和输出到字符串文本格式的接口，你只需关心翻译到 IR 的过程即可.</p>
<h3 id="utils">Utils<a class="headerlink" href="#utils" title="Permanent link">&para;</a></h3>
<p>在 <code>utils</code> 下，我们实现了侵入式链表 <code>List&lt;T&gt;</code>（位于 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template/-/blob/master/accsys/include/utils/list.h?ref_type=heads">list.h</a>）和前述基于模板的 RTTI （位于 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template/-/blob/master/accsys/include/utils/casting.h?ref_type=heads">casting.h</a>）</p>
<p>对于 <code>List&lt;T&gt;</code> 你通常不会直接使用到，一般只作为底层存放 IR 的数据结构.</p>
<p>对于 RTTI，我们实现了 <code>isa&lt;T&gt;()</code> <code>dyn_cast&lt;T&gt;()</code> 和 <code>cast&lt;T&gt;()</code> 三个函数：</p>
<ul>
<li><code>isa&lt;To&gt;(Val)</code>：返回 <code>Val</code> 是否为 To 类型</li>
<li><code>dyn_cast&lt;To&gt;(Val)</code>：如果 <code>Val</code> 为 To 类型，则进行 cast，否则返回 nullptr</li>
<li><code>cast&lt;To&gt;(Val)</code>： 如果 <code>Val</code> 为 To 类型，则进行 cast，否则报错</li>
</ul>
<p>上述三个函数使用模板并进行了偏特化，因此相比上述的 <code>is</code> 和 <code>as</code> 适用性更好，能够处理 <code>From &amp;Val</code>、<code>From *Val</code>、<code>const From *Val</code> 和 <code>const From *const Val</code> 等情况，并算出合适的返回类型，模板类型参数 To 不必须是指针类型</p>
<h3 id="type">Type 类<a class="headerlink" href="#type" title="Permanent link">&para;</a></h3>
<p>表示 Accipit IR 中的各类 Type，包括基类 <code>Type</code> 、派生类 <code>PointerType</code> 和 <code>FunctionType</code>.
定义于 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template/-/blob/master/accsys/include/ir/type.h?ref_type=heads">type.h</a></p>
<p>你只能使用静态成员函数获得 <code>Type *</code> 类型的值：</p>
<div class="highlight"><span class="filename">type.h</span><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">Type</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="nf">getPrimitiveTy</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">tid</span><span class="p">);</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="nf">getIntegerTy</span><span class="p">();</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="nf">getUnitTy</span><span class="p">();</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="p">};</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="k">class</span><span class="w"> </span><span class="nc">PointerType</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">PointerType</span><span class="w"> </span><span class="o">*</span><span class="nf">get</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">ElementType</span><span class="p">);</span>
<a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="p">};</span>
<a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a>
<a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">FunctionType</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="nf">get</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">Result</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Type</span><span class="w"> </span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Params</span><span class="p">);</span>
<a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w">    </span><span class="c1">//... </span>
<a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">FunctionType</span><span class="w"> </span><span class="o">*</span><span class="nf">get</span><span class="p">(</span><span class="n">Type</span><span class="w"> </span><span class="o">*</span><span class="n">Result</span><span class="p">);</span>
<a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="p">};</span>
</code></pre></div>
<p>我们对除 <code>FunctionType</code> 以外的类进行了缓存，因此你在大部分情况下可以以指针比较的方式比较两个 <code>Type</code> 是否相同：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">assert</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">getUnitTy</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Type</span><span class="o">::</span><span class="n">getUnitTy</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Type * should be the same&quot;</span><span class="p">)</span>
</code></pre></div>
<h3 id="value">Value 类<a class="headerlink" href="#value" title="Permanent link">&para;</a></h3>
<p><code>Value</code> 类定义于 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template/-/blob/master/accsys/include/ir/ir.h?ref_type=heads">ir.h</a>.
类继承关系如下图所示：</p>
<p><img alt="impl-value-instruction" src="../images/impl-value-instruction.svg" /></p>
<p>正如我们之前所述，<code>Value</code> 类包含符号和常数，具体来说，涉及：</p>
<ul>
<li>常数的基类 <code>Constant</code> 以及派生类 <code>ConstantInt</code> 与 <code>ConstantUnit</code></li>
<li>指令基类 <code>Instruction</code>，每种指令都有其对应的派生类，例如 <code>BinaryInst</code> 和 <code>AllocaInst</code>.</li>
<li>全局变量 <code>GlobalVariable</code> 和函数参数 <code>Argument</code></li>
</ul>
<p>几乎所有的 <code>Value</code> 都实现了静态成员函数 <code>Create</code> 并返回一个 <code>Value *</code> 类型的值.
<code>Value</code> 类构造函数都是私有的，你不允许直接调用它们，只能使用 Create 接口，因为 IR 内部有自己的内存管理方式.</p>
<p>出于实现上的方便，并维护 <code>use-def chain</code>，terminator 类型的指令也是 <code>Value</code> 的子类</p>
<h3 id="ir-structures">IR Structures<a class="headerlink" href="#ir-structures" title="Permanent link">&para;</a></h3>
<p><code>Instruction</code> 类，使用 <code>Instruction</code> 子类的 Create 接口构造，有以下重要的通用接口：</p>
<ul>
<li><code>getOpcode()</code> 获取指令的操作码，所有操作码是枚举 <code>BinaryOps</code>、<code>MemoryOps</code>、<code>OtherOps</code> 和 <code>TerminatorOps</code> 的其中一种.</li>
<li><code>getOperand()</code> 获取指令使用的 Value（操作数）.
注意，根据定义，Function 和 BasicBlock 等均不是 Value.</li>
<li>各类 insert 接口，将这条“游离”的指令插入到某个基本块中（<code>insertInto</code>），或插入某条指令之前（<code>insertBefore</code>）或之后（<code>insertAfter</code>）.</li>
</ul>
<p><code>BasicBlock</code> 类，基本块，通过 Create 接口构造，通过 <code>insertInto</code> 接口插入到某个函数中.</p>
<p><code>Function</code> 类，函数类，通过 Create 接口构造，需要指定其所在的 Module</p>
<p><code>GlobalVariable</code> 类，全局变量类，通过 Create 接口构造，需要指定其所在的 Module</p>
<p><code>Module</code> 类，编译单元，实现了 print 接口，打印 IR</p>
<h3 id="_13">使用示例和单元测试<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>IR 相关的部分编写了一些单元测试，位于 <a href="https://git.zju.edu.cn/accsys/accsys-cmake-template/-/tree/master/accsys/test?ref_type=heads">test</a> 子文件夹中，你可以运行这些测试，并参考我们提供的接口的使用方式</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../semantics/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Lab 2 语义分析">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Lab 2 语义分析
              </div>
            </div>
          </a>
        
        
          
          <a href="../backend/" class="md-footer__link md-footer__link--next" aria-label="下一页: Lab 4 后端代码生成（草稿）">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Lab 4 后端代码生成（草稿）
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate", "content.code.copy", "navigation.tracking", "navigation.top", "navigation.footer", "navigation.indexes", "navigation.sections"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../assets/javascripts/bundle.ad660dcc.min.js"></script>
      
        <script src="https://cdn.tonycrane.cc/utils/katex.min.js"></script>
      
        <script src="../javascripts/katex.js"></script>
      
    
  </body>
</html>